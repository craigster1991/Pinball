function createDOMObjects(){box1=domBox($("#upper-bottom-left-box"),!0,-2),box1.SetAngle(-55*D2R),box2=domBox($("#upper-bottom-right-box"),!0,-2),box2.SetAngle(55*D2R),flipperLeft=domBox($(".f-left"),!1,-2),flipperRight=domBox($(".f-right"),!1,-2),blueBall=domCircle($(".circle"),!1,-1,.5),leftInnerPin=domCircle($(".static-circle-il"),!1,-2),rightInnerPin=domCircle($(".static-circle-ir"),!1,-2),leftPin=domCircle($(".static-circle-l"),!0,-2),rightPin=domCircle($(".static-circle-r"),!0,-2),middlePin=domCircle($(".centrepin"),!0,-2),floor=domBox($("#floor"),!0),polygon=domPolygon($("#polygon"),[new b2Vec2(0/SCALE,-150/SCALE),new b2Vec2(10/SCALE,-30/SCALE),new b2Vec2(10/SCALE,30/SCALE),new b2Vec2(0/SCALE,150/SCALE),new b2Vec2(-10/SCALE,30/SCALE),new b2Vec2(-10/SCALE,-30/SCALE)],!1,1,.3),createWeldJoint(flipperLeft,leftInnerPin,leftInnerPin.GetWorldCenter()),createWeldJoint(flipperRight,rightInnerPin,rightInnerPin.GetWorldCenter()),createRevJoint(polygon,middlePin,!0,.5,!1),createRevJoint(flipperLeft,leftPin,!0,1e3,!0),createRevJoint(flipperRight,rightPin,!1,1e3,!0)}function domBox(e,t,o,n){var i=e.position(),r=e.width()/2,a=e.height()/2,l=i.left+r,d=i.top+a,s=createBox(l,d,r,a,t,o,n);return s.m_userData={domObj:e,width:r,height:a},e.css({left:"0px",top:"0px"}),s.GetBody()}function domCircle(e,t,o,n){var i=e.position(),r=e.width()/2,a=i.left+r,l=i.top+r,d=createCircle(a,l,r,t,o,n);return d.m_userData={domObj:e,width:r,height:r},e.css({left:"0px",top:"0px"}),d.GetBody()}function domPolygon(e,t,o,n,i){var r=e.position(),a=e.width()/2,l=e.height()/2,d=r.left+a,s=r.top+l,c=createPolygon(t,d,s,o,n,i);return c.m_userData={domObj:e,width:a,height:l},e.css({left:"0px",top:"0px"}),c.GetBody()}function createRevJoint(e,t,o,n,i){var r=new b2RevoluteJointDef;r.Initialize(e,t,t.GetWorldCenter()),r.upperAngle=35*D2R,r.lowerAngle=-35*D2R,r.enableLimit=i,r.maxMotorTorque=5e3,r.motorSpeed=o?-n:n,r.enableMotor=!0,world.CreateJoint(r)}function createWeldJoint(e,t,o){var n=new b2WeldJointDef;n.Initialize(e,t,o),world.CreateJoint(n)}function createBox(e,t,o,n,i,r,a){var l=new b2BodyDef;l.type=i?b2Body.b2_staticBody:b2Body.b2_dynamicBody,l.position.x=e/SCALE,l.position.y=t/SCALE;var d=new b2FixtureDef;return d.density=10,d.friction=.5,d.restitution="undefined"!=typeof a?a:.3,d.filter.groupIndex="undefined"!=typeof r?r:1,d.shape=new b2PolygonShape,d.shape.SetAsBox(o/SCALE,n/SCALE),world.CreateBody(l).CreateFixture(d)}function createCircle(e,t,o,n,i,r){var a=new b2BodyDef;a.type=n?b2Body.b2_staticBody:b2Body.b2_dynamicBody,a.position.x=e/SCALE,a.position.y=t/SCALE;var l=new b2FixtureDef;return l.density=.1,l.friction=.3,l.restitution="undefined"!=typeof r?r:.5,l.filter.groupIndex="undefined"!=typeof i?i:1,l.shape=new b2CircleShape(o/SCALE),world.CreateBody(a).CreateFixture(l)}function createPolygon(e,t,o,n,i,r){var a=new b2BodyDef;a.type=n?b2Body.b2_staticBody:b2Body.b2_dynamicBody,a.position.x=t/SCALE,a.position.y=o/SCALE;var l=new b2FixtureDef;return l.density=10,l.friction=.5,l.restitution="undefined"!=typeof r?r:.3,l.filter.groupIndex="undefined"!=typeof i?i:1,l.shape=new b2PolygonShape,l.shape.SetAsArray(e),world.CreateBody(a).CreateFixture(l)}function addEvents(){window.addEventListener("keypress",FlipIt,!1),window.addEventListener("mousedown",FlipItTap,!1),window.addEventListener("touchstart",FlipItTap,!1),box2d_ballContact()}function FlipIt(e){console.log("keypress"),[32].indexOf(e.keyCode)>-1&&(console.log("keypress - SPACE"),e.preventDefault(),keyPressed||(keyPressed=!0,flipperLeft.ApplyTorque(-1e5),flipperRight.ApplyTorque(1e5),setTimeout(function(){keyPressed=!1},300)))}function FlipItTap(){console.log("TAP"),keyPressed||(keyPressed=!0,flipperLeft.ApplyTorque(-1e5),flipperRight.ApplyTorque(1e5),setTimeout(function(){keyPressed=!1},300))}function box2d_ballContact(){var e=new b2ContactListener;e.EndContact=function(e){null!==e.GetFixtureA().GetUserData()&&null!==e.GetFixtureB().GetUserData()&&("#floor"==e.GetFixtureA().GetUserData().domObj.selector&&".circle"==e.GetFixtureB().GetUserData().domObj.selector||"#floor"==e.GetFixtureB().GetUserData().domObj.selector&&".circle"==e.GetFixtureA().GetUserData().domObj.selector)&&setTimeout(function(){blueBall.SetLinearVelocity(new b2Vec2(0,0)),blueBall.SetAngularVelocity(0),blueBall.SetPosition(new b2Vec2(100/SCALE,100/SCALE))},0)},this.world.SetContactListener(e)}function init(){canvas=$("#canvas")[0],ctx=canvas.getContext("2d"),setUpWorld(),createDOMObjects(),addEvents(),update(),interval=setInterval(update,1e3/60),resizeHandler()}function update(){world.Step(1/30,30,30),drawDOMObjects(),updateMouseDrag(),world.ClearForces(),fps.update(!0)}function drawDOMObjects(){for(var e=world.m_bodyList;e;e=e.m_next)for(var t=e.m_fixtureList;t;t=t.m_next)if(t.m_userData){var o=Math.floor(t.m_body.m_xf.position.x*SCALE-t.m_userData.width),n=Math.floor(t.m_body.m_xf.position.y*SCALE-t.m_userData.height),i=1,r=Math.round((t.m_body.m_sweep.a+PI2)%PI2*R2D*100)/100,a={"-webkit-transform":"translate3d("+o+"px,"+n+"px,"+i+"px) rotate("+r+"deg)","-moz-transform":"translate3d("+o+"px,"+n+"px,"+i+"px) rotate("+r+"deg)","-ms-transform":"translate3d("+o+"px,"+n+"px,"+i+"px) rotate("+r+"deg)","-o-transform":"translate3d("+o+"px,"+n+"px,"+i+"px) rotate("+r+"deg)",transform:"translate3d("+o+"px,"+n+"px,"+i+"px) rotate("+r+"deg)"};t.m_userData.domObj.css(a)}}function resizeHandler(){canvas.attr("width",$("#container").width()),canvas.attr("height",$("#container").height()),$(window).bind("resize",resizeHandler)}function setUpWorld(){world=new b2World(new b2Vec2(0,10),!0);var e=new b2DebugDraw;canvas=$("#canvas"),e.SetSprite(canvas[0].getContext("2d")),e.SetDrawScale(SCALE),e.SetFillAlpha(.5),e.SetLineThickness(1),e.SetFlags(b2DebugDraw.e_shapeBit|b2DebugDraw.e_jointBit),world.SetDebugDraw(e);var t=$("#container").width(),o=$("#container").height();createBox(0,o,t,2,!0,null,0),createBox(0,0,2,o,!0),createBox(t,0,2,o,!0),createBox(0,0,t,2,!0)}var world,interval,canvas,ctx,blueBall,leftInnerPin,rightInnerPin,leftPin,middlePin,rightPin,flipperLeft,flipperRight,box1,box2,listener,floor,polygon,debug=!1,keyPressed=!1,SCALE=30,D2R=Math.PI/180,R2D=180/Math.PI,PI2=2*Math.PI,b2Vec2=Box2D.Common.Math.b2Vec2,b2BodyDef=Box2D.Dynamics.b2BodyDef,b2AABB=Box2D.Collision.b2AABB,b2Body=Box2D.Dynamics.b2Body,b2FixtureDef=Box2D.Dynamics.b2FixtureDef,b2Fixture=Box2D.Dynamics.b2Fixture,b2World=Box2D.Dynamics.b2World,b2MassData=Box2D.Collision.Shapes.b2MassData,b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape,b2CircleShape=Box2D.Collision.Shapes.b2CircleShape,b2DebugDraw=Box2D.Dynamics.b2DebugDraw,b2MouseJointDef=Box2D.Dynamics.Joints.b2MouseJointDef,b2EdgeShape=Box2D.Collision.Shapes.b2EdgeShape,b2RevoluteJoint=Box2D.Dynamics.Joints.b2RevoluteJoint,b2RevoluteJointDef=Box2D.Dynamics.Joints.b2RevoluteJointDef,b2WeldJointDef=Box2D.Dynamics.Joints.b2WeldJointDef,b2ContactListener=Box2D.Dynamics.b2ContactListener;$(document).ready(init);